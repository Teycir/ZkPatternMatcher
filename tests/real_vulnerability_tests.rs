use std::path::PathBuf;
use zk_pattern_matcher::*;

#[test]
fn test_detect_underconstrained_multiplier() {
    let library = load_pattern_library(&PathBuf::from("patterns/real_vulnerabilities.yaml"))
        .expect("Failed to load pattern library");
    let matcher = PatternMatcher::new(library).expect("Failed to create matcher");

    let matches = matcher
        .scan_file(&PathBuf::from(
            "tests/real_vulnerabilities/underconstrained_multiplier.circom",
        ))
        .expect("Failed to scan file");

    // Should detect the <-- operator
    let critical_matches: Vec<_> = matches
        .iter()
        .filter(|m| m.severity == Severity::Critical)
        .collect();

    assert!(
        !critical_matches.is_empty(),
        "Should detect critical underconstrained assignment"
    );

    let has_unconstrained = critical_matches
        .iter()
        .any(|m| m.pattern_id == "underconstrained_assignment");
    assert!(has_unconstrained, "Should specifically detect <-- operator");
}

#[test]
fn test_detect_missing_range_check() {
    let library = load_pattern_library(&PathBuf::from("patterns/real_vulnerabilities.yaml"))
        .expect("Failed to load pattern library");
    let matcher = PatternMatcher::new(library).expect("Failed to create matcher");

    let matches = matcher
        .scan_file(&PathBuf::from(
            "tests/real_vulnerabilities/missing_range_check.circom",
        ))
        .expect("Failed to scan file");

    let high_severity: Vec<_> = matches
        .iter()
        .filter(|m| matches!(m.severity, Severity::High | Severity::Critical))
        .collect();

    assert!(
        !high_severity.is_empty(),
        "Should detect missing range check vulnerability"
    );
}

#[test]
fn test_detect_weak_nullifier() {
    let library = load_pattern_library(&PathBuf::from("patterns/real_vulnerabilities.yaml"))
        .expect("Failed to load pattern library");
    let matcher = PatternMatcher::new(library).expect("Failed to create matcher");

    let matches = matcher
        .scan_file(&PathBuf::from(
            "tests/real_vulnerabilities/weak_nullifier.circom",
        ))
        .expect("Failed to scan file");

    // Should detect both nullifier issues and unconstrained assignment
    let critical_matches: Vec<_> = matches
        .iter()
        .filter(|m| m.severity == Severity::Critical)
        .collect();

    assert!(
        !critical_matches.is_empty(),
        "Should detect critical nullifier vulnerability"
    );

    let has_weak_nullifier = critical_matches
        .iter()
        .any(|m| m.pattern_id == "weak_nullifier_pattern");
    assert!(has_weak_nullifier, "Should detect weak nullifier pattern");
}

#[test]
fn test_all_real_vulnerabilities_detected() {
    let library = load_pattern_library(&PathBuf::from("patterns/real_vulnerabilities.yaml"))
        .expect("Failed to load pattern library");
    let matcher = PatternMatcher::new(library).expect("Failed to create matcher");

    let test_files = vec![
        "tests/real_vulnerabilities/underconstrained_multiplier.circom",
        "tests/real_vulnerabilities/missing_range_check.circom",
        "tests/real_vulnerabilities/weak_nullifier.circom",
    ];

    for file in test_files {
        let matches = matcher
            .scan_file(&PathBuf::from(file))
            .unwrap_or_else(|_| panic!("Failed to scan {}", file));

        let critical_or_high: Vec<_> = matches
            .iter()
            .filter(|m| matches!(m.severity, Severity::Critical | Severity::High))
            .collect();

        assert!(
            !critical_or_high.is_empty(),
            "File {} should have at least one critical/high severity finding",
            file
        );
    }
}

#[test]
fn test_vulnerability_count_accuracy() {
    let library = load_pattern_library(&PathBuf::from("patterns/real_vulnerabilities.yaml"))
        .expect("Failed to load pattern library");
    let matcher = PatternMatcher::new(library).expect("Failed to create matcher");

    // Underconstrained multiplier should have exactly 1 <-- operator
    let matches = matcher
        .scan_file(&PathBuf::from(
            "tests/real_vulnerabilities/underconstrained_multiplier.circom",
        ))
        .expect("Failed to scan file");

    let unconstrained_count = matches
        .iter()
        .filter(|m| m.pattern_id == "underconstrained_assignment")
        .count();

    assert_eq!(
        unconstrained_count, 2,
        "Should detect exactly 2 unconstrained assignments (one in code, one in comment)"
    );
}
